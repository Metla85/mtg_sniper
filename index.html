<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Sniper - Pro Trader</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <style>
        /* ESTILOS PERSONALIZADOS */
        body { -webkit-tap-highlight-color: transparent; }
        .card-row:hover { background-color: #f8fafc; transition: background-color 0.15s; }
        
        /* Badges de Ratio */
        .ratio-badge { font-family: monospace; font-weight: 700; padding: 2px 6px; border-radius: 4px; display: inline-block; min-width: 50px; text-align: center; }
        .ratio-extreme { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; } /* Verde fuerte */
        .ratio-high { background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; } /* Gris */

        /* Iconos de acci√≥n */
        .icon-btn { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 8px; transition: all 0.2s; }
        .icon-btn:hover { background-color: #f1f5f9; transform: scale(1.1); }
        
        /* Ajustes M√≥vil */
        @media (max-width: 640px) {
            .hide-mobile { display: none; }
            body { padding: 0.75rem; background-color: #f8fafc; }
            .mobile-card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">

    <div id="config-screen" class="hidden fixed inset-0 bg-slate-900 z-[999] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                <div class="inline-block p-3 bg-indigo-100 rounded-full mb-3 text-2xl">üîê</div>
                <h2 class="text-xl font-bold text-slate-800">Conectar Sniper</h2>
                <p class="text-xs text-slate-500 mt-2">Tus claves se guardan solo en este dispositivo.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Supabase URL</label>
                    <input type="text" id="input-url" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-mono">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Anon Key</label>
                    <input type="password" id="input-key" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-mono">
                </div>
                <button onclick="saveConfig()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-indigo-200">
                    Entrar
                </button>
            </div>
        </div>
    </div>

    <div id="main-screen" class="max-w-6xl mx-auto opacity-0 transition-opacity duration-500">
        
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
            <div class="w-full md:w-auto flex justify-between items-center">
                <div>
                    <h1 class="font-black text-slate-800 tracking-tight flex items-center gap-2 text-2xl md:text-3xl">
                        MTG Sniper <span class="text-[10px] bg-indigo-600 text-white px-1.5 py-0.5 rounded tracking-widest uppercase align-middle transform -translate-y-1">PRO</span>
                    </h1>
                    <p class="text-xs text-slate-400 font-medium" id="status-text">Cargando motor...</p>
                </div>
                <button onclick="resetConfig()" class="md:hidden text-xl p-2 opacity-50">‚öôÔ∏è</button>
            </div>

            <div class="w-full md:w-auto flex flex-col md:flex-row gap-2">
                <div class="relative w-full md:w-64">
                    <input type="text" id="search-input" onkeyup="filterData()" placeholder="Buscar carta..." 
                        class="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm shadow-sm">
                    <svg class="w-4 h-4 text-slate-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="copyToClipboardSafe()" class="flex-1 bg-white hover:bg-slate-50 text-indigo-700 border border-slate-200 font-bold py-2.5 px-4 rounded-lg shadow-sm text-sm transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        Copiar Lista
                    </button>
                    <button onclick="resetConfig()" class="hidden md:block bg-white hover:bg-slate-50 text-slate-400 border border-slate-200 p-2.5 rounded-lg shadow-sm" title="Configuraci√≥n">‚öôÔ∏è</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr class="text-xs uppercase text-slate-500 font-bold tracking-wider">
                            <th class="px-4 py-3 text-left pl-6">Carta</th>
                            <th class="px-2 py-3 text-center">Set</th>
                            <th class="px-4 py-3 text-right cursor-pointer hover:bg-slate-100 select-none" onclick="sortData('eur')">EUR ‚ñº</th>
                            <th class="hide-mobile px-4 py-3 text-right cursor-pointer hover:bg-slate-100 select-none" onclick="sortData('usd')">USD ‚ñº</th>
                            <th class="px-4 py-3 text-center cursor-pointer hover:bg-slate-100 select-none" onclick="sortData('ratio')">Gap ‚ñº</th>
                            <th class="px-4 py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-8 text-center text-xs text-slate-400 pb-10 space-y-1">
            <p>üî• = Rank Top 500 + Ratio > 2.0 (Alta Liquidez)</p>
            <p>üõí Enlaces filtrados autom√°ticos: English + Excellent Condition</p>
        </div>
    </div>

    <script>
        // --- L√ìGICA DE LA APLICACI√ìN ---
        let supabase = null;
        let globalData = [];
        let filteredData = [];

        // 1. INICIALIZACI√ìN
        function initApp() {
            const storedUrl = localStorage.getItem('supabase_url');
            const storedKey = localStorage.getItem('supabase_key');

            if (!storedUrl || !storedKey) {
                document.getElementById('config-screen').classList.remove('hidden');
            } else {
                document.getElementById('config-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('opacity-0');
                try {
                    supabase = window.supabase.createClient(storedUrl, storedKey);
                    loadData();
                } catch (e) { resetConfig(); }
            }
        }

        // 2. CARGA DE DATOS
        async function loadData() {
            const { data, error } = await supabase.rpc('get_arbitrage_opportunities');
            if (error) {
                document.getElementById('status-text').innerHTML = `<span class="text-red-500">‚ùå Error de conexi√≥n</span>`;
                return;
            }
            
            // Ordenar por Ratio descendente por defecto
            globalData = data.sort((a, b) => b.ratio - a.ratio);
            filteredData = globalData;
            renderTable();
            
            // Stats
            const total = data.length;
            const hot = data.filter(i => i.edhrec_rank < 500 && i.ratio > 2.0).length;
            document.getElementById('status-text').innerHTML = `üü¢ Online | <b>${total}</b> Oportunidades | üî• <b>${hot}</b> Hot`;
        }

        // 3. RENDERIZADO (TABLA)
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-12 text-slate-400">Sin resultados</td></tr>`;
                return;
            }

            filteredData.forEach(item => {
                const ratioClass = item.ratio > 2.0 ? 'ratio-extreme' : 'ratio-high';
                
                // Hot Icon Logic: Si es muy jugada (rank < 500) y tiene buen margen (> 2.0)
                const isHot = (item.edhrec_rank < 500 && item.ratio > 2.0);
                const hotIcon = isHot ? '<span class="mr-1 text-base animate-pulse" title="Alta Liquidez">üî•</span>' : '';
                
                // Limpieza de Nombres para URLs
                const cleanName = item.name.replace(/'/g, ''); // Quita ap√≥strofes
                const cleanNameUrl = cleanName.replace(/ /g, '-').replace(/\/\/.*/, ''); // Quita espacios y segunda parte de split cards

                // --- GENERACI√ìN DE ENLACES ---
                // MKM: Filtrado por IDIOMA (1=English) y ESTADO (3=Excellent)
                const mkmLink = `https://www.cardmarket.com/en/Magic/Cards/${cleanNameUrl}?language=1&minCondition=3`;
                // Card Kingdom: B√∫squeda en Buylist
                const ckLink = `https://www.cardkingdom.com/purchasing/mtg_singles?search=header&filter%5Bname%5D=${encodeURIComponent(item.name)}`;
                // EDHRec: An√°lisis
                const edhLink = `https://edhrec.com/cards/${cleanNameUrl.toLowerCase()}`;

                const row = `
                    <tr class="card-row border-b border-slate-100">
                        <td class="px-4 py-3 pl-6">
                            <div class="flex items-center gap-3">
                                <div class="relative hidden md:block group">
                                    <img src="${item.image_uri}" class="w-10 h-10 rounded-full border border-slate-200 object-cover cursor-pointer">
                                    <img class="hidden group-hover:block absolute z-50 w-56 rounded-lg shadow-2xl border-4 border-white top-0 left-12" src="${item.image_uri}" style="top:-50%; min-width:220px;">
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm leading-tight flex items-center">
                                        ${hotIcon}
                                        <a href="${mkmLink}" target="_blank" class="hover:text-indigo-600 hover:underline">${item.name}</a>
                                    </div>
                                    <div class="text-[10px] text-slate-400 md:hidden uppercase mt-0.5 font-bold tracking-wide">${item.set_code}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-2 py-3 text-center">
                             <span class="bg-slate-100 text-slate-500 border border-slate-200 px-1.5 py-0.5 rounded text-[10px] font-mono font-bold uppercase hidden md:inline-block cursor-help" title="${item.set_code}">${item.set_code}</span>
                        </td>
                        <td class="px-4 py-3 text-right font-mono font-bold text-slate-700 text-sm">${item.eur.toFixed(2)}‚Ç¨</td>
                        <td class="hide-mobile px-4 py-3 text-right font-mono text-slate-400 text-sm">$${item.usd.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="ratio-badge ${ratioClass} text-sm">${item.ratio}x</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-1 md:gap-3">
                                <a href="${mkmLink}" target="_blank" class="icon-btn text-indigo-600 bg-indigo-50" title="Comprar (MKM)">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                </a>
                                <a href="${ckLink}" target="_blank" class="icon-btn text-emerald-600 hover:bg-emerald-50" title="Vender (CK Buylist)">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z"/><path d="M12 8v4l3 3"/></svg>
                                </a>
                                <a href="${edhLink}" target="_blank" class="icon-btn text-purple-600 hover:bg-purple-50 hidden md:flex" title="EDHStats">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // 4. UTILIDADES (Filtros, Sort, Config)
        function filterData() {
            const term = document.getElementById('search-input').value.toLowerCase();
            filteredData = globalData.filter(item => 
                item.name.toLowerCase().includes(term) || 
                item.set_code.toLowerCase().includes(term)
            );
            renderTable();
        }

        function sortData(key) {
            filteredData.sort((a, b) => b[key] - a[key]);
            renderTable();
        }

        function saveConfig() {
            localStorage.setItem('supabase_url', document.getElementById('input-url').value.trim());
            localStorage.setItem('supabase_key', document.getElementById('input-key').value.trim());
            location.reload();
        }

        function resetConfig() {
            if(confirm("¬øBorrar claves y salir?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function copyToClipboardSafe() {
            if (!filteredData.length) return;
            const top50 = filteredData.slice(0, 50);
            
            // Generador de lista de texto para Wants List
            const listText = top50.map(item => {
                const cleanName = item.name.split(' // ')[0]; 
                return `1 ${cleanName} (${item.set_code})`;
            }).join('\n');

            // Fallback para m√≥vil (textarea oculto)
            const textArea = document.createElement("textarea");
            textArea.value = listText;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            
            try { 
                document.execCommand('copy');
                Toastify({ 
                    text: "‚úÖ Lista Copiada (50 Cartas)", 
                    duration: 3000, 
                    gravity: "top", 
                    style: { background: "#4f46e5", boxShadow: "0 10px 15px -3px rgba(0, 0, 0, 0.1)" } 
                }).showToast();
            } catch (e) { alert("Error copiando"); }
            
            document.body.removeChild(textArea);
        }

        // Arrancar
        initApp();
    </script>
</body>
                        </html>
                        
