<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Sniper v3.5</title> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .card-row:hover { background-color: #f8fafc; cursor: pointer; }
        .ratio-badge { font-family: monospace; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
        .ratio-extreme { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .ratio-high { background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; }
        .active-tab { border-bottom: 3px solid #ef4444; color: #ef4444; background: #fef2f2; } /* ROJO TEMPORAL */
        .inactive-tab { color: #64748b; }
        .rank-up { color: #10b981; } .rank-down { color: #ef4444; }
        .icon-btn { opacity: 0.8; width: 32px; height: 32px; display:flex; justify-content: center; align-items: center; }
        @media (max-width: 640px) { .hide-mobile { display: none; } body { padding: 0.5rem; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">

    <div id="config-screen" class="hidden fixed inset-0 bg-slate-900 z-[999] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold text-center mb-4 text-red-600">Conectar Sniper v3.5</h2>
            <input type="text" id="input-url" placeholder="URL" class="w-full p-3 border rounded-xl mb-3">
            <input type="password" id="input-key" placeholder="Key" class="w-full p-3 border rounded-xl mb-4">
            <button onclick="saveConfig()" class="w-full bg-red-600 text-white font-bold py-3.5 rounded-xl">Entrar</button>
        </div>
    </div>

    <div id="main-screen" class="max-w-6xl mx-auto opacity-0">
        <div class="mb-4 pt-2 flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tight text-red-600">MTG Sniper <span class="text-xs text-black opacity-50">v3.5 CHECK</span></h1>
            <button onclick="resetConfig()" class="text-xl p-2 opacity-50">‚öôÔ∏è</button>
        </div>

        <div class="flex mb-4 bg-white rounded-lg shadow-sm border border-slate-200">
            <button onclick="switchMode('arbitrage')" id="tab-arbitrage" class="flex-1 py-3 font-bold text-sm uppercase active-tab">‚öñÔ∏è Arbitraje</button>
            <button onclick="switchMode('trend')" id="tab-trend" class="flex-1 py-3 font-bold text-sm uppercase inactive-tab">üöÄ Tendencias</button>
            <button onclick="switchMode('demand')" id="tab-demand" class="flex-1 py-3 font-bold text-sm uppercase inactive-tab">üìà Demanda</button>
        </div>

        <div class="flex justify-between items-center mb-4 px-1">
            <p class="text-xs text-slate-500" id="status-text">Iniciando...</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm"><tbody id="table-body"></tbody></table>
            </div>
        </div>
    </div>
    
    <div id="chart-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')"><div class="bg-white p-4 rounded-xl w-full h-64"><canvas id="priceChart"></canvas></div></div>

    <script>
        let supabase = null;
        let currentMode = 'arbitrage';
        let currentData = [];
        let chartInstance = null;

        function initApp() {
            const url = localStorage.getItem('supabase_url');
            const key = localStorage.getItem('supabase_key');
            if (!url || !key) { document.getElementById('config-screen').classList.remove('hidden'); }
            else {
                document.getElementById('config-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('opacity-0');
                supabase = window.supabase.createClient(url, key);
                loadData();
            }
        }

        async function loadData() {
            document.getElementById('status-text').innerText = "Conectando...";
            
            let query;
            // ESTRATEGIA H√çBRIDA (RPC + SELECT DIRECTO)
            if (currentMode === 'arbitrage') query = supabase.rpc('get_arbitrage_opportunities');
            else if (currentMode === 'trend') query = supabase.rpc('get_us_spikes');
            else if (currentMode === 'demand') query = supabase.from('edhrec_demand_spikes').select('*').order('ratio', {ascending:false});

            const { data, error } = await query;
            
            if (error) { 
                // MOSTRAMOS EL ERROR EN PANTALLA
                document.getElementById('table-body').innerHTML = `<tr><td class="p-4 text-red-500 font-bold text-center">ERROR: ${error.message}</td></tr>`;
                document.getElementById('status-text').innerText = "‚ùå Error";
                return; 
            }
            
            currentData = (currentMode !== 'demand') ? data.sort((a,b)=>b.ratio-a.ratio) : data;
            document.getElementById('status-text').innerText = `‚úÖ ${data.length} Cartas`;
            renderTable();
        }

        function switchMode(mode) {
            currentMode = mode;
            ['arbitrage', 'trend', 'demand'].forEach(m => {
                document.getElementById(`tab-${m}`).className = (m === mode) ? 'flex-1 py-3 font-bold text-sm uppercase active-tab' : 'flex-1 py-3 font-bold text-sm uppercase inactive-tab';
            });
            loadData();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            if (!currentData.length) { tbody.innerHTML = `<tr><td class="p-8 text-center text-slate-400">Sin datos.</td></tr>`; return; }

            currentData.forEach((item, index) => {
                let val = (currentMode === 'demand') ? `+${Math.round(item.ratio)}` : (item.ratio.toFixed(2) + (currentMode==='trend'?'%':'x'));
                let rank = (item.edhrec_rank > 0) ? `#${item.edhrec_rank}` : '‚Äî';
                
                // Generar filas simples
                const row = `
                    <tr class="card-row border-b border-slate-100" onclick="alert('Gr√°fica para: ${item.name}')">
                        <td class="px-4 py-3 font-bold">${item.name} <span class="text-xs text-slate-400">(${item.set_code})</span></td>
                        <td class="px-4 py-3 text-right">${item.eur.toFixed(2)}‚Ç¨</td>
                        <td class="px-4 py-3 text-center bg-green-50 text-green-700 font-bold">${val}</td>
                        <td class="px-4 py-3 text-center text-xs text-slate-500">${rank}</td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        function saveConfig() { localStorage.setItem('supabase_url', document.getElementById('input-url').value.trim()); localStorage.setItem('supabase_key', document.getElementById('input-key').value.trim()); location.reload(); }
        function resetConfig() { localStorage.clear(); location.reload(); }
        initApp();
    </script>
</body>
</html>
