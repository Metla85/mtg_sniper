<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Sniper - Pro Trader</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <style>
        .card-row:hover { background-color: #f8fafc; transition: background-color 0.15s; }
        .ratio-badge { font-family: monospace; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
        .ratio-extreme { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .ratio-high { background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; }
        
        /* Iconos de acciones */
        .icon-btn { opacity: 0.6; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }

        @media (max-width: 640px) {
            .hide-mobile { display: none; }
            body { padding: 0.5rem; }
            .mobile-stack { flex-direction: column; gap: 0.5rem; }
        }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8 min-h-screen text-slate-800">

    <div id="config-screen" class="hidden fixed inset-0 bg-slate-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">üîê Acceso Seguro</h2>
            <div class="space-y-4">
                <input type="text" id="input-url" placeholder="Supabase URL" class="w-full p-3 border rounded-lg">
                <input type="password" id="input-key" placeholder="Anon Key" class="w-full p-3 border rounded-lg">
                <button onclick="saveConfig()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Conectar</button>
            </div>
        </div>
    </div>

    <div id="main-screen" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-500">
        
        <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <div class="w-full md:w-auto">
                    <h1 class="text-2xl font-black text-slate-800 tracking-tight flex items-center gap-2">
                        üéØ MTG Sniper <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">PRO</span>
                    </h1>
                    <p class="text-xs text-slate-400 mt-1" id="status-text">Iniciando...</p>
                </div>

                <div class="w-full md:w-96 relative">
                    <input type="text" id="search-input" onkeyup="filterData()" placeholder="Buscar carta o set..." 
                        class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                    <svg class="w-4 h-4 text-slate-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>

                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="copyToClipboardSafe()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm text-sm transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        Copiar Lista
                    </button>
                    <button onclick="resetConfig()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 p-2 rounded-lg" title="Configuraci√≥n">‚öôÔ∏è</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-bold tracking-wider">
                            <th class="px-4 py-3 text-left">Carta</th>
                            <th class="px-2 py-3 text-center">Set</th>
                            <th class="px-4 py-3 text-right cursor-pointer hover:bg-slate-100" onclick="sortData('eur')">EUR ‚ñº</th>
                            <th class="hide-mobile px-4 py-3 text-right cursor-pointer hover:bg-slate-100" onclick="sortData('usd')">USD ‚ñº</th>
                            <th class="px-4 py-3 text-center cursor-pointer hover:bg-slate-100" onclick="sortData('ratio')">Gap ‚ñº</th>
                            <th class="px-4 py-3 text-center">Investigaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-6 text-center text-xs text-slate-400 pb-10">
            <p>üí° Tip: Usa el icono ü¶Ö para ver si CardKingdom te compra la carta (Arbitraje Directo).</p>
        </div>
    </div>

    <script>
        // --- CORE LOGIC ---
        let supabase = null;
        let globalData = [];
        let filteredData = [];

        function initApp() {
            const storedUrl = localStorage.getItem('supabase_url');
            const storedKey = localStorage.getItem('supabase_key');

            if (!storedUrl || !storedKey) {
                document.getElementById('config-screen').classList.remove('hidden');
            } else {
                document.getElementById('config-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('opacity-0');
                try {
                    supabase = window.supabase.createClient(storedUrl, storedKey);
                    loadData();
                } catch (e) { resetConfig(); }
            }
        }

        async function loadData() {
            const { data, error } = await supabase.rpc('get_arbitrage_opportunities');
            if (error) {
                document.getElementById('status-text').innerText = "‚ùå Error API";
                return;
            }
            
            // Ordenar por Ratio por defecto
            globalData = data.sort((a, b) => b.ratio - a.ratio);
            filteredData = globalData;
            renderTable();
            document.getElementById('status-text').innerText = `Actualizado: ${new Date().toLocaleDateString()} | ${data.length} Oportunidades`;
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-slate-400">Sin resultados</td></tr>`;
                return;
            }

            filteredData.forEach(item => {
                const ratioClass = item.ratio > 2.0 ? 'ratio-extreme' : 'ratio-high';
                const cleanName = item.name.replace(/'/g, ''); 
                
                // Links Generados
                const mkmLink = `https://www.cardmarket.com/en/Magic/Cards/${cleanName.replace(/ /g, '-')}`;
                const ckLink = `https://www.cardkingdom.com/purchasing/mtg_singles?search=header&filter%5Bname%5D=${encodeURIComponent(item.name)}`;
                const edhLink = `https://edhrec.com/cards/${cleanName.toLowerCase().replace(/ /g, '-').replace(/\/\/.*/, '')}`; // Fix split cards

                const row = `
                    <tr class="card-row border-b border-slate-100">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <img src="${item.image_uri}" class="w-10 h-10 rounded-full border border-slate-200 object-cover hidden md:block">
                                <div>
                                    <div class="font-bold text-slate-800 leading-tight">${item.name}</div>
                                    <div class="text-xs text-slate-400 md:hidden uppercase mt-0.5">${item.set_code}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-2 py-3 text-center">
                             <span class="bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded text-[10px] font-mono font-bold uppercase hidden md:inline-block">${item.set_code}</span>
                        </td>
                        <td class="px-4 py-3 text-right font-mono font-bold text-slate-700">${item.eur.toFixed(2)}‚Ç¨</td>
                        <td class="hide-mobile px-4 py-3 text-right font-mono text-slate-400">$${item.usd.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="ratio-badge ${ratioClass}">${item.ratio}x</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-3">
                                <a href="${mkmLink}" target="_blank" class="icon-btn text-blue-600" title="Comprar en Cardmarket">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                </a>
                                <a href="${ckLink}" target="_blank" class="icon-btn text-green-600" title="Vender en Card Kingdom (Buylist)">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z"/><path d="M12 8v4l3 3"/></svg>
                                </a>
                                <a href="${edhLink}" target="_blank" class="icon-btn text-purple-600" title="Ver en EDHRec">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- UTILS ---
        function filterData() {
            const term = document.getElementById('search-input').value.toLowerCase();
            filteredData = globalData.filter(item => 
                item.name.toLowerCase().includes(term) || 
                item.set_code.toLowerCase().includes(term)
            );
            renderTable();
        }

        function sortData(key) {
            filteredData.sort((a, b) => b[key] - a[key]);
            renderTable();
        }

        function saveConfig() {
            localStorage.setItem('supabase_url', document.getElementById('input-url').value.trim());
            localStorage.setItem('supabase_key', document.getElementById('input-key').value.trim());
            location.reload();
        }

        function resetConfig() {
            if(confirm("¬øBorrar claves?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function copyToClipboardSafe() {
            if (!filteredData.length) return;
            // Solo copiamos las visibles (filtradas) o top 50
            const list = filteredData.slice(0, 50).map(i => `1 ${i.name.split(' // ')[0]} (${i.set_code})`).join('\n');
            
            const textArea = document.createElement("textarea");
            textArea.value = list;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try { document.execCommand('copy'); 
                Toastify({ text: "‚úÖ Lista Copiada", duration: 2000, style: { background: "#4f46e5" } }).showToast();
            } catch (e) { alert("Error copiando"); }
            document.body.removeChild(textArea);
        }

        // Init
        initApp();
    </script>
</body>
                        </html>
    
